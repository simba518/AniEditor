\documentclass[9pt,twocolumn]{extarticle}

\usepackage[hmargin=0.5in,tmargin=0.5in]{geometry}
\usepackage{amsmath,amssymb}
\usepackage{times}

\usepackage{cleveref}
\usepackage{color}
\newcommand{\TODO}[1]{\textcolor{red}{#1}}

\newcommand{\FPP}[2]{\frac{\partial #1}{\partial #2}}
\newcommand{\argmin}{\operatornamewithlimits{arg\ min}}

\title{Elastic Motion Editing}

\begin{document}
\maketitle

\setlength{\parskip}{0.5ex}

\begin{abstract}
  We propose a method to create an elastic animation by optimizing
  both the control force and material.  The key feature is smaller
  control force and more consistent effect.
\end{abstract}

\section{Introduction}

Traditional method to create an animation is to interpolate a set of
key frames.  Two problems here:
\begin{itemize}
\item User needs to provide a set of key frames which describes the
  whole shape of the model at specific times.  We argue that
  incomplete key frame (positional constraints) could improve the
  efficiency of animation authoring and quality of the final results.
\item The interpolation method often leads to over-smoothed result
  because of lacking proper dynamics effects.  Increasing the number
  of key frames can alleviate the problem, however, requires more
  tedious human work.  Thus, we propose to integrate the equation of
  motion into the animation authoring procedure.
\end{itemize}

Recently, some methods have been proposed for physically based
sequence editing, which could be applied to create the animation as
well.  But, in these methods, only moderate change is allowed,
otherwise, there would be great distortion making the result
unnatural.  More importantly, They require the input sequence coming
with a proper equation of motion, e.g. the stiffness, mass etc.
Unsuitable material setting leads large control force.  Be more
specific, there will be the following typical problems:
\begin{itemize}
\item The dynamics around the editing frame is not consistent with the
  other frames far away from the editing frame.
\item Repeatedly editing is required for desired periodically
  behavior.
\end{itemize}

However, a suitable material setting is not easy to get in general,
and such a requirement imposes additional difficulty than the
traditional key frame based method.

In this paper, we propose a method to progressively create an
animation by space-time constraints, which is driven by an equation of
motion with material to be optimized.


\section{Overview}
We take the assumption that the desired sequence can be approximated
by the equation of motion in RS-space (ignoring the damping for
simplicity):
\begin{equation}
  \ddot{z} + \Lambda z=0,
\end{equation}
where $z \in R^m$ is the coordinates under the basis $W \in R^{n\times
  m}$, $m,n$ are the number of modes and number of mesh vertices
respectively.

The user input, i.e. the space-time constraints, is represented as:
\begin{equation}\label{opt_ctrl}
  C_ix(z(t_i), W, r) - \tilde{x}_i = 0, \quad i \in \{1, 2, \cdots,
  T\}
\end{equation}
which means a set of linear positional constraints at time $t_i$, and
$x(z(t), W, r)$ is the shape related to the coordinates $z$, basis
$W$ and rest shape $r$.

As a consequence, the problem can be formulated as:
\begin{equation}
  \argmin_{z,\Lambda,r,W} \int_0^T \|\ddot{z} + \Lambda z\|_{M_z}^2 + \sum_i \|C_ix(z(t_i), W, r) - \tilde{x}_i\|_{M_c}^2,
  \label{eq:final_eq}
\end{equation}
where $M_z$ and $M_c$ are the metric for the norm.  We use the penalty
here because the positional constraints are not required to be exactly
satisfied.  It is a possible requirement that $W^TMW=I, W^TKW=\Lambda$
where $M$ and $K$ are ``reasonable'' mass and stiffness matrix.

There are many variables here: $m\times T$ for $z$, $m$ for $\Lambda$,
$n$ for $r$ and $n\times m$ for $W$, thus it should be very difficult
to optimize.  Thus we propose the following method to update the
variables $z^k, \Lambda^k,r^k, W^k$ to $z^{k+1}, \Lambda^{k+1},
k^{k+1}, W^{k+1}$ in $k_{th}$ iteration, and update the sequence $x^k$
to $x^{k+1}$:
\begin{enumerate}
\item Sequence Editing (\Cref{sec:reduc-rs-coord}): Using
  $\Lambda^k, r^k, W^k$ to solve the sequence $z^k$, and then get
  $x^k$ under the constraints.  If the control force is nearly same to
  the previous one, the iteration stops.
\item Material Estimation (\Cref{sec:mat-est}):
  \begin{enumerate}
  \item Estimate the $r^{k+1}, W^{k+1}$ from the input sequence $x^k$
    (by PCA or other method).
  \item Estimate $z^{k+1}$ from $x^k$ with $r^{k+1}, W^{k+1}$.
  \item Estimate $\Lambda^{k+1}$ from $z^{k+1}$, and possibly, the
    damping.
  \end{enumerate}
\item Continue to the next iteration.
\end{enumerate}

\section{Reduced RS Method}
\subsection{Background}\label{sec:warping-methods}
Suppose the displacement $u(z)=x(z)-r$, then there are many methods to compute
$u(z)$, such as linear mapping (e.g $u = \bar{u}+Wz$), modal warping, or RS
coordinates. Experiments show that, when the deformation is extremely large,
only the RS coordinates method can produce plausible results. Here, we briefly
review the old RS coordinates, and we refer is as full-RS here. Using full-RS,
we compute $u(z)$ by solving
\begin{equation}
  \min_{u} \frac{1}{2}\sum_{Tets}\|(Gu)_i + I - e^{y_i^w}(I+y_i^s)\||V_i|
\end{equation}
where $y = Wz$ is the RS coordinate, $G$ is the discrete gradient operator with
respect to the rest shape $r$. This is equal to solve a linear system
\begin{equation} \label{rs}
  Au = b(y) = b(Wz).
\end{equation}
where $A$ is a constant sparse matrix. Thus, using this formulation, we need to
compute $y$ for all the elements, and then solve a large linear system to even
only displacement $u_i\in R^{3}$ of one node $i$. And if we want to compute
$\frac{\partial{u_i}}{\partial{z}}$, which is necessary for solving the
optimization problem (\ref{opt_ctrl}), the performance would be much worse.

\subsection{Reduced RS}\label{sec:reduc-rs-coord}
To improve the performance, we proposed a reduced RS method for
computing $u(z)=x(z)-r$.  The basic idea is to apply cubature to write
$x(z)$ into the form of $x(z) = r+B\sum_{e\in{S}}w_eP_e{b_e(y(z))}$,
where $S$ the set of sampled tets.

Let \TODO{$B$ be some linear basis matrix}, and $q$ is the
corresponding reduced coordinates. By replacing $u = Bq$ into
(\ref{rs}), and multiply $B^T$in both sides, we obtain
\begin{equation} \label{reduced_rs1}
  B^T(ABq) = B^Tb(y)
\end{equation}
Then we can compute $q$ using
\begin{equation} \label{reduced_rs2}
  q = Pb(y)
\end{equation}
where $P = (B^TAB)^{-1}B^T$. By using the Cubature scheme, we can further
approximate $q$ with
\begin{equation} \label{reduced_rs3}
  q \approx \sum_{e\in{S}}w_eP_e{b_e(y(z))}
\end{equation}
In a conclusion, given $z$, we firstly compute $q$ using (\ref{reduced_rs3}),
then compute $u$ using $u=Bq$.

\subsection{Analysis}
We compared this reduced RS approach with Modal Analysis, Modal Warping, and
previous full-RS method, and the results demonstrate that, the deformation
results of the reduced RS method is similar to the full-RS method, and much
better than the MA and MW method.

This approach will be helpful in solving the optimal control problem
efficiently, as it is much cheaper to compute $u_i(z)\in R^3$ and
$\frac{\partial{u_i}}{\partial{z}}\in R^{3\times r_z}$ for each constrained node
$i$ than full-RS method. By using reduced RS method, the computational
complexity of calculating $u_i(z)$ is $O(Sr_q+Sr_z)$, and
$\frac{\partial{u_i}}{\partial{z}}$ is $O(Sr_qr_z)$, where $S$ is the number of
samples, $r_z$ is the dimension of $z$, and $r_q$ is the dimension of $q$. While
by using full-RS method, the corresponding computational complexity would be
$N_{tet}r_z$ (or $nr_z$, with $n$ is the number of nodes) and $N^2_{tet}r_z$,
where $N_{tet}$ is the number of total tetrahedrons.

One limitation of this method is similar to the full-RS method. That is, we can
not project the external forces in full space into this RS space. Thus it can
not be used in forward simulation.

\section{Material Estimation}\label{sec:mat-est}
\subsection{Material Estimation from a Sequence}
Given a sequence as $x(t)$, we can have the sequence of RS coordinates
$\hat{x}(t)$ respect to a rest shape $r$.

Then taking a PCA on $\hat{x}(t)$ for the best $m$ basis $W'$ to cover
these deformations:
\begin{equation}
  \hat{x}(t) \approx W'z'(t).
\end{equation}

It is very likely that $z'(t)$ does not satisfy the following equation
well:
\begin{equation}
  \ddot{z}'_i(t) + \lambda_i z'_i(t) = 0.
\end{equation}
However, we may \TODO{approximate} $z'(t)$ by:
\begin{equation}
  \ddot{z}'(t) + K z'(t) \approx 0,
\end{equation}
where $K$ is a $m \times m$ SPD matrix.  Then, taking eigen
decomposition $K=U\Lambda U^T$, we have:
\begin{equation}
  \ddot{z}'(t) + U\Lambda U^T z'(t) = 0 \Leftrightarrow \ddot{z}(t) + \Lambda z(t) = 0,
\end{equation}
where $z(t)=U^Tz'(t)$.  As a consequence, we have:
\begin{equation}
  \hat{x}(t) \approx (W'U^T) z(t) = W z(t).
\end{equation}

It is hopefully that $\Lambda, W$ is a good estimation of the material.

We can continue to update $W$ by fixing $z, \Lambda$, and solve
\Cref{eq:final_eq}.  It may be difficult, we need to find better
method.

\subsection{Key Frame Constraints}
Let's start from a simple case, that the space-time constraints are
key frame constraints, i.e. the whole shape is known at the
constrained time.

A simple way is to construct a smooth interpolation between these key
frames, and then using the above method.  After estimating the
material, we could use previous method for dynamic interpolation, and
then again, estimate the material.  \TODO{Hope it converges to a good
  solution}.

\subsection{Partial Constraints}
Turn it into a sequence editing problem with the feature of material
updating by the above method.

\subsection{Analysis}
Based on some experiment results obtained these days, we give some simple
analysis of this method here.

Given the input sequence $z_0,\cdots,z_T$, and time step $h$, we minimize a
quadratic energy function for $d$ and $k$,
\begin{equation} \label{qua-en}
  E(k,d) = \sum_{i=2}^{T-1} \|\frac{1}{h^2}\hat{z}_i+\frac{1}{h}{D}(d)(z_{i+1}-z_{i})+ K(k)z_i\|_2^2
\end{equation}
where $\hat{z}_i=z_{i+1}-2z_{i}+z_{i-1}$, ${D}(d)$ and $K(k)$ are
symmetric matrix, and $d, k$ are the DOFs of these matrices
respectively. We consider the damping $D$ here, as it can improve the
material approximation according to our experiments.

When $z_i$ is generated using a simulator (without external forces),
we can approximate $K$ and $D$ almost exactly.

When $z_i$ is recovered from a sequence $x(t)$ generated by RS method
with the basis $\hat{W}$, we can approximate the material of the first
few modes (6 modes in one experiment), and the approximation of the
remaining modes are very bad.

When we have no information about the material, we cannot get extract
basis $\hat{W}$ used to generate $x(t)$.  Thus, we have tried use PCA
to get the basis $W'$, and then recover $z_i$.  We found that $W'z_i$
can approximate $\hat{x}$ very well with even small columns in $W'$,
and the resulting $z'$ will differs greatly from the truth $z$
(obtained by using $\hat{W}$).  In such a cases, it is hard to
approximate these material. When $\hat{W}$ is used, and the input
sequence $x(t)$ is generate using a RS method.

Currently, we haven't considered the problem of constrained nodes and
external forces in these experiments.

\end{document}